filter {
  if [module] == "obd2" {
    csv {
          columns =>
            [
              "time",
              "obd2.bms.airbag_h-wire_duty",
              "obd2.bms.auxillary_battery_voltage",
              "obd2.bms.available_charge_power",
              "obd2.bms.available_discharge_power",
              "obd2.bms.battery_cell_voltage_deviation",
              "obd2.bms.battery_current",
              "obd2.bms.battery_dc_voltage",
              "obd2.bms.battery_fan_feedback",
              "obd2.bms.battery_fan_status",
              "obd2.bms.battery_heater_1_temperature",
              "obd2.bms.battery_inlet_temperature",
              "obd2.bms.battery_management",
              "obd2.bms.battery_max_temperature",
              "obd2.bms.battery_min_temperature",
              "obd2.bms.battery_pack_b01",
              "obd2.bms.battery_pack_b02",
              "obd2.bms.battery_pack_b03",
              "obd2.bms.battery_pack_b04",
              "obd2.bms.battery_pack_b05",
              "obd2.bms.battery_pack_b06",
              "obd2.bms.battery_pack_b07",
              "obd2.bms.battery_pack_b08",
              "obd2.bms.battery_pack_b09",
              "obd2.bms.battery_pack_b10",
              "obd2.bms.battery_pack_b11",
              "obd2.bms.battery_pack_b12",
              "obd2.bms.battery_pack_b13",
              "obd2.bms.battery_pack_b14",
              "obd2.bms.battery_pack_b15",
              "obd2.bms.battery_pack_b16",
              "obd2.bms.battery_power",
              "obd2.bms.bms_ignition",
              "obd2.bms.bms_main_relay",
              "obd2.bms.calc_average_cell_voltage_58kwh",
              "obd2.bms.calc_average_cell_voltage_72kwh",
              "obd2.bms.calc_average_cell_voltage_77kwh",
              "obd2.bms.calc_estimated_time_100kw_80percent_charge",
              "obd2.bms.calc_estimated_time_11kw_80percent_charge",
              "obd2.bms.calc_estimated_time_150kw_80percent_charge",
              "obd2.bms.calc_estimated_time_175kw_80percent_charge",
              "obd2.bms.calc_estimated_time_2.3kw_80percent_charge",
              "obd2.bms.calc_estimated_time_3.7kw_80percent_charge",
              "obd2.bms.calc_estimated_time_350kw_80percent_charge",
              "obd2.bms.calc_estimated_time_50kw_80percent_charge",
              "obd2.bms.calc_estimated_time_7.4kw_80percent_charge",
              "obd2.bms.cell_voltage_001",
              "obd2.bms.cell_voltage_002",
              "obd2.bms.cell_voltage_003",
              "obd2.bms.cell_voltage_004",
              "obd2.bms.cell_voltage_005",
              "obd2.bms.cell_voltage_006",
              "obd2.bms.cell_voltage_007",
              "obd2.bms.cell_voltage_008",
              "obd2.bms.cell_voltage_009",
              "obd2.bms.cell_voltage_010",
              "obd2.bms.cell_voltage_011",
              "obd2.bms.cell_voltage_012",
              "obd2.bms.cell_voltage_013",
              "obd2.bms.cell_voltage_014",
              "obd2.bms.cell_voltage_015",
              "obd2.bms.cell_voltage_016",
              "obd2.bms.cell_voltage_017",
              "obd2.bms.cell_voltage_018",
              "obd2.bms.cell_voltage_019",
              "obd2.bms.cell_voltage_020",
              "obd2.bms.cell_voltage_021",
              "obd2.bms.cell_voltage_022",
              "obd2.bms.cell_voltage_023",
              "obd2.bms.cell_voltage_024",
              "obd2.bms.cell_voltage_025",
              "obd2.bms.cell_voltage_026",
              "obd2.bms.cell_voltage_027",
              "obd2.bms.cell_voltage_028",
              "obd2.bms.cell_voltage_029",
              "obd2.bms.cell_voltage_030",
              "obd2.bms.cell_voltage_031",
              "obd2.bms.cell_voltage_032",
              "obd2.bms.cell_voltage_033",
              "obd2.bms.cell_voltage_034",
              "obd2.bms.cell_voltage_035",
              "obd2.bms.cell_voltage_036",
              "obd2.bms.cell_voltage_037",
              "obd2.bms.cell_voltage_038",
              "obd2.bms.cell_voltage_039",
              "obd2.bms.cell_voltage_040",
              "obd2.bms.cell_voltage_041",
              "obd2.bms.cell_voltage_042",
              "obd2.bms.cell_voltage_043",
              "obd2.bms.cell_voltage_044",
              "obd2.bms.cell_voltage_045",
              "obd2.bms.cell_voltage_046",
              "obd2.bms.cell_voltage_047",
              "obd2.bms.cell_voltage_048",
              "obd2.bms.cell_voltage_049",
              "obd2.bms.cell_voltage_050",
              "obd2.bms.cell_voltage_051",
              "obd2.bms.cell_voltage_052",
              "obd2.bms.cell_voltage_053",
              "obd2.bms.cell_voltage_054",
              "obd2.bms.cell_voltage_055",
              "obd2.bms.cell_voltage_056",
              "obd2.bms.cell_voltage_057",
              "obd2.bms.cell_voltage_058",
              "obd2.bms.cell_voltage_059",
              "obd2.bms.cell_voltage_060",
              "obd2.bms.cell_voltage_061",
              "obd2.bms.cell_voltage_062",
              "obd2.bms.cell_voltage_063",
              "obd2.bms.cell_voltage_064",
              "obd2.bms.cell_voltage_065",
              "obd2.bms.cell_voltage_066",
              "obd2.bms.cell_voltage_067",
              "obd2.bms.cell_voltage_068",
              "obd2.bms.cell_voltage_069",
              "obd2.bms.cell_voltage_070",
              "obd2.bms.cell_voltage_071",
              "obd2.bms.cell_voltage_072",
              "obd2.bms.cell_voltage_073",
              "obd2.bms.cell_voltage_074",
              "obd2.bms.cell_voltage_075",
              "obd2.bms.cell_voltage_076",
              "obd2.bms.cell_voltage_077",
              "obd2.bms.cell_voltage_078",
              "obd2.bms.cell_voltage_079",
              "obd2.bms.cell_voltage_080",
              "obd2.bms.cell_voltage_081",
              "obd2.bms.cell_voltage_082",
              "obd2.bms.cell_voltage_083",
              "obd2.bms.cell_voltage_084",
              "obd2.bms.cell_voltage_085",
              "obd2.bms.cell_voltage_086",
              "obd2.bms.cell_voltage_087",
              "obd2.bms.cell_voltage_088",
              "obd2.bms.cell_voltage_089",
              "obd2.bms.cell_voltage_090",
              "obd2.bms.cell_voltage_091",
              "obd2.bms.cell_voltage_092",
              "obd2.bms.cell_voltage_093",
              "obd2.bms.cell_voltage_094",
              "obd2.bms.cell_voltage_095",
              "obd2.bms.cell_voltage_096",
              "obd2.bms.cell_voltage_097",
              "obd2.bms.cell_voltage_098",
              "obd2.bms.cell_voltage_099",
              "obd2.bms.cell_voltage_100",
              "obd2.bms.cell_voltage_101",
              "obd2.bms.cell_voltage_102",
              "obd2.bms.cell_voltage_103",
              "obd2.bms.cell_voltage_104",
              "obd2.bms.cell_voltage_105",
              "obd2.bms.cell_voltage_106",
              "obd2.bms.cell_voltage_107",
              "obd2.bms.cell_voltage_108",
              "obd2.bms.cell_voltage_109",
              "obd2.bms.cell_voltage_110",
              "obd2.bms.cell_voltage_111",
              "obd2.bms.cell_voltage_112",
              "obd2.bms.cell_voltage_113",
              "obd2.bms.cell_voltage_114",
              "obd2.bms.cell_voltage_115",
              "obd2.bms.cell_voltage_116",
              "obd2.bms.cell_voltage_117",
              "obd2.bms.cell_voltage_118",
              "obd2.bms.cell_voltage_119",
              "obd2.bms.cell_voltage_120",
              "obd2.bms.cell_voltage_121",
              "obd2.bms.cell_voltage_122",
              "obd2.bms.cell_voltage_123",
              "obd2.bms.cell_voltage_124",
              "obd2.bms.cell_voltage_125",
              "obd2.bms.cell_voltage_126",
              "obd2.bms.cell_voltage_127",
              "obd2.bms.cell_voltage_128",
              "obd2.bms.cell_voltage_129",
              "obd2.bms.cell_voltage_130",
              "obd2.bms.cell_voltage_131",
              "obd2.bms.cell_voltage_132",
              "obd2.bms.cell_voltage_133",
              "obd2.bms.cell_voltage_134",
              "obd2.bms.cell_voltage_135",
              "obd2.bms.cell_voltage_136",
              "obd2.bms.cell_voltage_137",
              "obd2.bms.cell_voltage_138",
              "obd2.bms.cell_voltage_139",
              "obd2.bms.cell_voltage_140",
              "obd2.bms.cell_voltage_141",
              "obd2.bms.cell_voltage_142",
              "obd2.bms.cell_voltage_143",
              "obd2.bms.cell_voltage_144",
              "obd2.bms.cell_voltage_145",
              "obd2.bms.cell_voltage_146",
              "obd2.bms.cell_voltage_147",
              "obd2.bms.cell_voltage_148",
              "obd2.bms.cell_voltage_149",
              "obd2.bms.cell_voltage_150",
              "obd2.bms.cell_voltage_151",
              "obd2.bms.cell_voltage_152",
              "obd2.bms.cell_voltage_153",
              "obd2.bms.cell_voltage_154",
              "obd2.bms.cell_voltage_155",
              "obd2.bms.cell_voltage_156",
              "obd2.bms.cell_voltage_157",
              "obd2.bms.cell_voltage_158",
              "obd2.bms.cell_voltage_159",
              "obd2.bms.cell_voltage_160",
              "obd2.bms.cell_voltage_161",
              "obd2.bms.cell_voltage_162",
              "obd2.bms.cell_voltage_163",
              "obd2.bms.cell_voltage_164",
              "obd2.bms.cell_voltage_165",
              "obd2.bms.cell_voltage_166",
              "obd2.bms.cell_voltage_167",
              "obd2.bms.cell_voltage_168",
              "obd2.bms.cell_voltage_169",
              "obd2.bms.cell_voltage_170",
              "obd2.bms.cell_voltage_171",
              "obd2.bms.cell_voltage_172",
              "obd2.bms.cell_voltage_173",
              "obd2.bms.cell_voltage_174",
              "obd2.bms.cell_voltage_175",
              "obd2.bms.cell_voltage_176",
              "obd2.bms.cell_voltage_177",
              "obd2.bms.cell_voltage_178",
              "obd2.bms.cell_voltage_179",
              "obd2.bms.cell_voltage_180",
              "obd2.bms.coolant_temperature_2",
              "obd2.bms.cumulative_charge_current",
              "obd2.bms.cumulative_discharge_current",
              "obd2.bms.cumulative_energy_charged",
              "obd2.bms.cumulative_energy_discharged",
              "obd2.bms.drive_motor_speed_1",
              "obd2.bms.drive_motor_speed_2",
              "obd2.bms.hv_charging",
              "obd2.bms.inverter_capacitor_voltage",
              "obd2.bms.isolation_resistance",
              "obd2.bms.maximum_cell_voltage",
              "obd2.bms.maximum_cell_voltage_no",
              "obd2.bms.maximum_deterioration_cell_no",
              "obd2.bms.minimum_cell_voltage",
              "obd2.bms.minimum_cell_voltage_no",
              "obd2.bms.minimum_deterioration",
              "obd2.bms.minimum_deterioration_cell_no",
              "obd2.bms.normal_charge_port",
              "obd2.bms.operating_time",
              "obd2.bms.rapid_charge_port",
              "obd2.bms.state_of_charge_bms",
              "obd2.bms.state_of_charge_display",
              "obd2.bms.state_of_health",
              "obd2.dash.odometer",
              "obd2.hvac.coolant_temperature_1",
              "obd2.hvac.evaporator_temperature",
              "obd2.hvac.indoor_temperature",
              "obd2.hvac.inverter_temperature",
              "obd2.hvac.outdoor_temperature",
              "obd2.hvac.real_vehicle_speed",
              "obd2.tpms.tire_pressure_back_left",
              "obd2.tpms.tire_pressure_back_right",
              "obd2.tpms.tire_pressure_front_left",
              "obd2.tpms.tire_pressure_front_right",
              "obd2.tpms.tire_temperature_back_left",
              "obd2.tpms.tire_temperature_back_right",
              "obd2.tpms.tire_temperature_front_left",
              "obd2.tpms.tire_temperature_front_right",
              "obd2.acceleration",
              "obd2.brake_light",
              "obd2.distance_parcourue",
              "obd2.distance_parcourue",
              "obd2.distance_parcourue_avec_un_temoin_d'anomalie_moteur_allume",
              "obd2.distance_parcourue_depuis_l'effacement_des_codes_defauts",
              "obd2.duree_de_vie_restante_du_bloc_de_batterie",
              "obd2.ev_instant_energy_consumption",
              "obd2.ev_instant_energy_consumption_kwh-100km",
              "obd2.hybrid_ev_battery_power",
              "obd2.low_beams",
              "obd2.max_cell_voltage",
              "obd2.min_cell_voltage",
              "obd2.nombre_de_rechauffements_depuis_leffacement_des_codes_defauts",
              "obd2.tension_elm327",
              "obd2.vitesse_gps",
              "obd2.vitesse_moyenne",
              "obd2.vitesse_moyenne_gps"
            ]
    }
   
    # Skip the header
    if [time] == "time" { drop {} }
    
    # Extract the time from the file name.
    # Car scanner seems to only log the time (hours, minutes and seconds) in the csv export
    # For the time being, I only have found the day in the filename
    # This retrieves the day in order to inject it in the timestamp along with the time field
    grok {
      match => ["path","%{GREEDYDATA}/(?<file_day>%{YEAR}-%{MONTHNUM2}-%{MONTHDAY}) (?<file_time>%{HOUR}-%{MINUTE}-%{SECOND}).csv"]
      add_field => { "event_time" => "%{file_day}T%{time}" }   
    }
    
    date { match => ["event_time" , "YYYY-MM-dd'T'HH:mm:ss.SSS" ]  }

    
     

  }
}
